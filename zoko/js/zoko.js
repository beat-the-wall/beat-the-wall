var BoxBlock,BoxObject,Camera,CameraController,EmptyBlock,Game,Highscore,LevelState,LevelView,LiftBlock,LiftObject,Observable,PlatformBlock,Player,PlayerController,PlayerObject,SkyObject,SolidBlock,StaticLevelObject,UI,Zoko,createTextures,e3d,loadFilesUsing,loadImageFile,loadImageFiles,loadJsonFile,loadJsonFiles,loadResourceFiles,makeBackFace,makeBox,makeFrontFace,makeLeftFace,makeLidlessBox,makeQuad,makeRightFace,makeTopFace,mat,resource_dir,vec,__hasProp={}.hasOwnProperty,__extends=function(e,t){for(var r in t)__hasProp.call(t,r)&&(e[r]=t[r]);function n(){this.constructor=e}return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},__indexOf=[].indexOf||function(e){for(var t=0,r=this.length;t<r;t++)if(t in this&&this[t]===e)return t;return-1};Observable=function(){function e(){}return e.prototype.notifyObservers=function(){var e,t,r,n,o;if(null!=this.observers){for(o=[],t=0,r=(n=this.observers).length;t<r;t++)null!=(e=n[t])?o.push(e.update(this,arguments)):o.push(void 0);return o}},e}(),CameraController=function(){return function(e,t){var r,n,o,i;r=e.camera,n=!1,o=0,i=0,$(t).on("mousedown",function(e){return n=!0,o=e.screenX,i=e.screenY}),$(document).on("mouseup",function(e){return n=!1}).on("mousemove",function(e){var t,s;if(n)return t=.01*(e.screenX-o),s=.01*(e.screenY-i),r.rotate(t,s),o=e.screenX,i=e.screenY})}}(),Game=function(e){var t;function r(e){this.levelView=e,this.currentLevel=1,this.numLevels=5,this.loadCurrentLevel(),this.solvedLevels=[],this.highscore=new Highscore}return __extends(r,Observable),t=function(e,t){var r;for(r=""+e;r.length<t;)r="0"+r;return r},r.prototype.newGame=function(){},r.prototype.restartLevel=function(){return this.loadCurrentLevel()},r.prototype.nextLevel=function(){return this.currentLevel++,this.currentLevel>this.numLevels&&(this.currentLevel=1),this.loadCurrentLevel()},r.prototype.previousLevel=function(){return this.currentLevel--,this.currentLevel<0&&(this.currentLevel=this.numLevels),this.loadCurrentLevel()},r.prototype.loadCurrentLevel=function(){var e,r;return r="levels/"+t(this.currentLevel,2)+".json",e=this,loadJsonFile(r,function(t){var r;return(r=new LevelState(t)).onUpdate=function(){return e.notifyObservers(r)},r.observers=[e.levelView],r.notifyObservers()})},r}(),Highscore=function(){function e(){this.list=this.getHighscoreObj()}return e.prototype.getHighscoreObj=function(){var e;return null!=(e=localStorage.getItem("highscore"))?JSON.parse(e):{1:0,2:0,3:0,4:0,5:0}},e.prototype.setHighscore=function(e,t){var r;if((r=this.list[e])>t||0===r)return this.list[e]=t,localStorage.setItem("highscore",JSON.stringify(this.list))},e.prototype.getHighscore=function(e){return this.list[e]},e}(),EmptyBlock=function(){function e(e,t){this.level=e,this.position=t}return e.prototype.type="empty",e.prototype.static=!1,e.prototype.move=function(){return"empty"!==this.level.blockBelow(this.position).type},e.prototype.update=function(){return!1},e}(),SolidBlock=function(){function e(){}return e.prototype.type="solid",e.prototype.static=!0,e.prototype.move=function(){return!1},e.prototype.update=function(){return!1},e}(),PlatformBlock=function(){function e(){}return e.prototype.type="platform",e.prototype.static=!0,e.prototype.move=function(){return!1},e.prototype.update=function(){return!1},e}(),BoxBlock=function(){function e(e,t){this.level=e,this.position=t}return e.prototype.type="box",e.prototype.static=!1,e.prototype.move=function(e,t){var r,n,o;return!!(t>=1&&(n=this.position,o=vec.add(n,e),this.level.blockAt(o).move(e,t-1)))&&(r=vec.add(n,[0,0,1]),this.level.blockAt(r).move(e,t),this.level.swapBlocksAt(n,o),!0)},e.prototype.update=function(){return 1,this.move([0,0,-1],1)},e}(),LiftBlock=function(){function e(e,t){this.level=e,this.position=t,this.bottom=this.position[2],this.top=this.position[2]}return e.prototype.type="lift",e.prototype.static=!1,e.prototype.move=function(){return!1},e.prototype.update=function(){var e,t,r,n,o;if(o=[0,0,1],r=[0,0,-1],n=this.position,e=vec.add(n,o),t=vec.add(n,r),"empty"===this.level.blockAt(e).type){if(n[2]!==this.bottom&&"empty"===this.level.blockAt(t).type)return this.level.swapBlocksAt(n,t),!0}else if(n[2]!==this.top&&(1/0,this.level.blockAt(e).move(o,1/0)))return this.level.swapBlocksAt(n,e),!0;return!1},e}(),Player=function(){function e(e,t){this.level=e,this.position=t,this.direction=[0,1,0]}return e.prototype.type="player",e.prototype.static=!1,e.prototype.move=function(e,t){var r,n;return 0===e[2]&&(this.direction=e),r=this.position,n=vec.add(r,e),!!this.level.blockAt(n).move(e,t)&&(this.level.swapBlocksAt(r,n),!0)},e.prototype.update=function(){return 1,this.move([0,0,-1],1)},e}(),LevelState=function(e){function t(e){var t,r,n,o,i,s,a,u;this.blockArray=function(){var r,c,l;for(l=[],u=r=0,c=e.length;r<c;u=++r)n=e[u],l.push(function(){var e,r,c;for(c=[],a=e=0,r=n.length;e<r;a=++e)i=n[a],c.push(function(){var e,r,n;for(n=[],s=e=0,r=i.length;e<r;s=++e)switch(t=i[s],o=[s,a,u],t){case"O":n.push(new SolidBlock);break;case"X":n.push(new PlatformBlock);break;case"#":n.push(new BoxBlock(this,o));break;case"^":n.push(new LiftBlock(this,o));break;case"S":n.push(this.player=new Player(this,o));break;default:n.push(new EmptyBlock(this,o))}return n}.call(this));return c}.call(this));return l}.call(this),this.height=this.blockArray.length,this.depth=this.blockArray[0].length,this.width=this.blockArray[0][0].length,r=this,this.forEach("lift",function(e,t){var n;if("lift"===(n=r.blockBelow(t)).type)return n.top=t[2],r.setBlockAt(t,new EmptyBlock)}),this.steps=0,this.asleep=!1,this.solved=!1,this.onUpdate=function(){}}return __extends(t,Observable),t.prototype.forEach=function(e,t){var r,n,o,i,s,a,u,c,l,h,p,f,d,v;for(o=[],u=c=0,p=(v=this.blockArray).length;c<p;u=++c)for(a=l=0,f=(n=v[u]).length;l<f;a=++l)for(s=h=0,d=(i=n[a]).length;h<d;s=++h)(r=i[s]).type===e&&o.push(t(r,[s,a,u]));return o},t.prototype.forEachBlock=function(e){var t,r,n,o,i,s,a,u,c,l;for(c=this.blockArray,l=[],s=a=0,u=c.length;a<u;s=++a)r=c[s],l.push(function(){var a,u,c;for(c=[],i=a=0,u=r.length;a<u;i=++a)n=r[i],c.push(function(){var r,a,u;for(u=[],o=r=0,a=n.length;r<a;o=++r)t=n[o],u.push(e(t,[o,i,s]));return u}());return c}());return l},t.prototype.blockAt=function(e){var t,r,n;return t=e[0],r=e[1],n=e[2],t<0||t>=this.width?new EmptyBlock(this,e):r<0||r>=this.depth?new EmptyBlock(this,e):n<0||n>=this.height?new EmptyBlock(this,e):this.blockArray[n][r][t]},t.prototype.blockBelow=function(e){var t,r,n,o;for(r=e[0],n=e[1],o=e[2];!(--o<0);)if("empty"!==(t=this.blockAt([r,n,o])).type)return t;return new EmptyBlock(this,[r,n,o])},t.prototype.setBlockAt=function(e,t){var r,n,o;return t.level=this,t.position=e,r=e[0],n=e[1],o=e[2],this.blockArray[o][n][r]=t},t.prototype.swapBlocksAt=function(e,t){var r,n;return r=this.blockAt(e),n=this.blockAt(t),this.setBlockAt(e,n),this.setBlockAt(t,r)},t.prototype.movePlayer=function(e){var t;if(!this.solved&&!this.asleep&&(t=function(){switch(e){case"left":return[-1,0,0];case"up":return[0,-1,0];case"right":return[1,0,0];case"down":return[0,1,0]}}(),1,this.player.move(t,1)))return this.steps++,this.update(!0)},t.prototype.checkIfSolved=function(){var e,t;if(e=!0,t=this,this.forEach("box",function(r,n){if("platform"!==t.blockBelow(n).type)return e=!1}),!0===e)return this.solved=!0},t.prototype.update=function(e){var t;return null==e&&(e=!1),!1===e&&this.forEachBlock(function(t){return e=t.update()||e}),e?(this.onUpdate(),this.asleep=!0,t=this,this.notifyObservers(function(){return t.update()})):(this.checkIfSolved(),this.solved&&this.onUpdate(),this.asleep=!1),e},t}(),PlayerController=function(){var e,t;return t=[{left:"left",up:"up",right:"right",down:"down"},{left:"up",up:"right",right:"down",down:"left"},{left:"right",up:"down",right:"left",down:"up"},{left:"down",up:"left",right:"up",down:"right"}],e=function(e){var r,n;return(n=(e+Math.PI/4)%(2*Math.PI))<0&&(n+=2*Math.PI),r=Math.floor(n/(Math.PI/2)),t[r]},function(t){var r;r=t.camera,$(document).on("keydown",function(n){var o,i,s;switch(i=t.currState,s=r.rotation[2],o=e(s),n.which){case 37:return i.movePlayer(o.left),!1;case 38:return i.movePlayer(o.up),!1;case 39:return i.movePlayer(o.right),!1;case 40:return i.movePlayer(o.down),!1}return!0})}}(),resource_dir="resources/",loadImageFile=function(e,t){var r;return(r=new Image).onload=function(){return t(r)},r.src=resource_dir+e},loadJsonFile=function(e,t){var r;return(r=new XMLHttpRequest).open("GET",resource_dir+e,!0),r.onreadystatechange=function(){var e;if(4===r.readyState)return e=JSON.parse(r.responseText),t(e)},r.send()},loadFilesUsing=function(e,t,r){var n,o,i,s,a,u;if(t instanceof Object==!1)return e(t,r);if(t instanceof Array)a=t.length,i=[];else{for(o in a=0,t)__hasProp.call(t,o)&&a++;i={}}for(o in s=0,u=[],t)__hasProp.call(t,o)&&(n=t[o],u.push(function(t){return loadFilesUsing(e,n,function(e){if(i[t]=e,++s===a)return r(i)})}(o)));return u},loadImageFiles=function(e,t){return loadFilesUsing(loadImageFile,e,t)},loadJsonFiles=function(e,t){return loadFilesUsing(loadJsonFile,e,t)},loadResourceFiles=function(e,t){var r,n,o;return r=!1,n=!1,o={},loadImageFiles(e.images,function(e){if(o.images=e,r=!0,n)return t(o)}),loadJsonFiles(e.json,function(e){if(o.json=e,n=!0,r)return t(o)})},UI=function(){function e(e){var t;this.game=e,this.stepsCounter=$("#steps"),this.levelCounter=$("#level").find(".levelNumber"),this.nextBtn=$("#nextBtn"),this.previousBtn=$("#previousBtn"),this.menu=$("#menu"),this.menu.hide(),this.menuTitle=this.menu.find(".title"),this.menuOverlay=$("#menuOverlay"),this.menuOverlay.hide(),this.menuShown=!1,this.continueBtn=$("#continueBtn"),this.continueBtn.hide(),this.restartBtn=$("#restartBtn"),this.menuBtn=$("#menuBtn"),this.highscoreTable=$(".highscore > .table"),t=this,this.nextBtn.on("click",function(){if(t.menu.fadeOut(),t.menuOverlay.fadeOut(),t.menuShown=!1,null!=(e=t.game))return e.nextLevel(),t.levelCounter.html(e.currentLevel),t.resetStepsCount()}),this.previousBtn.on("click",function(){if(t.menu.fadeOut(),t.menuOverlay.fadeOut(),t.menuShown=!1,null!=(e=t.game))return e.previousLevel(),t.levelCounter.html(e.currentLevel),t.resetStepsCount()}),this.restartBtn.on("click",function(){if(null!=(e=t.game)&&!t.menuShown)return e.restartLevel(),t.resetStepsCount()}),this.menuBtn.on("click",function(){var e,r;return t.menuShown?(t.menu.fadeOut(),t.menuOverlay.fadeOut(),t.menuShown=!1):(t.setMenuTitle("Options"),t.updateHighscoreTable(),t.continueBtn.show(),e=t.game.currentLevel,__indexOf.call(t.game.solvedLevels,e)>=0?t.nextBtn.show():t.nextBtn.hide(),r=t.game.currentLevel-1,__indexOf.call(t.game.solvedLevels,r)>=0?t.previousBtn.show():t.previousBtn.hide(),t.menuOverlay.fadeIn(),t.menu.fadeIn(),t.menuShown=!0)}),this.continueBtn.on("click",function(){return t.menu.fadeOut(),t.menuOverlay.fadeOut(),t.menuShown=!1}),$(document).on("keydown",function(r){switch(r.which){case 82:null==(e=t.game)||t.menuShown||(e.restartLevel(),t.resetStepsCount())}return!0})}return e.prototype.update=function(e,t){var r,n,o;return this.game=e,n=(r=t[0]).steps,r.solved&&(this.game.highscore.setHighscore(e.currentLevel,n),this.game.solvedLevels.push(this.game.currentLevel),this.continueBtn.hide(),this.setMenuTitle("Good job!"),this.updateHighscoreTable(),this.nextBtn.show(),o=this.game.currentLevel-1,__indexOf.call(this.game.solvedLevels,o)>=0?this.previousBtn.show():this.previousBtn.hide(),this.menuOverlay.fadeIn(),this.menu.fadeIn(),this.menuShown=!0),this.updateStepsCount(n)},e.prototype.showWinnerModal=function(){},e.prototype.updateStepsCount=function(e){return this.stepsCounter.html(e+" steps")},e.prototype.resetStepsCount=function(){return this.stepsCounter.html("0 steps")},e.prototype.setMenuTitle=function(e){return this.menuTitle.html(e)},e.prototype.updateHighscoreTable=function(){var e,t;return t=this.highscoreTable.find("tbody"),e=this,t.children().each(function(t,r){return $(r).children("td").last().html(e.game.highscore.getHighscore(t+1)+" steps")})},e}(),(e3d=e3d||{}).Camera=function(){function e(){this.position=[0,0,0],this.rotation=[0,0,0],this.distance=0}return e.prototype.createMatrix=function(){var e,t,r,n,o;return 45,e=e3d.width/e3d.height,.1,100,t=[0,0,0],n=[0,-1,0],o=[0,0,1],r=mat.perspective(45,e,.1,100),r=mat.lookat(r,t,n,o),r=mat.translate(r,[0,-this.distance,0]),r=mat.rotateX(r,-this.rotation[0]),r=mat.rotateY(r,-this.rotation[1]),r=mat.rotateZ(r,-this.rotation[2]),r=mat.translate(r,vec.neg(this.position))},e}(),(e3d=e3d||{}).init=function(e){var t;return(t=e.getContext("experimental-webgl",{alpha:!1})).enable(t.DEPTH_TEST),e3d.width=e.width,e3d.height=e.height,e3d.gl=t,e3d.scene=null,e3d.noTexture=new e3d.Texture(null),e3d.onrender=null,e3d.program.mesh.init()},e3d.run=function(){var e,t;return t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)},e=function(){var r;if(t(e),(r=e3d.gl).clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),null!=e3d.scene&&e3d.scene.render(),null!=e3d.onrender)return e3d.onrender()},t(e)},mat={row:function(e,t){return[e[4*t+0],e[4*t+1],e[4*t+2],e[4*t+3]]},col:function(e,t){return[e[t+0],e[t+4],e[t+8],e[t+12]]},mul:function(e,t){var r,n,o,i,s,a,u,c,l;return r=mat.col(e,0),n=mat.col(e,1),o=mat.col(e,2),i=mat.col(e,3),a=mat.row(t,0),u=mat.row(t,1),c=mat.row(t,2),l=mat.row(t,3),[(s=vec.dot4)(r,a),s(n,a),s(o,a),s(i,a),s(r,u),s(n,u),s(o,u),s(i,u),s(r,c),s(n,c),s(o,c),s(i,c),s(r,l),s(n,l),s(o,l),s(i,l)]},translate:function(e,t){var r;return r=[1,0,0,0,0,1,0,0,0,0,1,0,t[0],t[1],t[2],1],mat.mul(e,r)},scale:function(e,t){var r;return r=[t[0],0,0,0,0,t[1],0,0,0,0,t[2],0,0,0,0,1],mat.mul(e,r)},rotateX:function(e,t){var r,n,o;return o=Math.sin(t),n=[1,0,0,0,0,r=Math.cos(t),o,0,0,-o,r,0,0,0,0,1],mat.mul(e,n)},rotateY:function(e,t){var r,n,o;return o=Math.sin(t),n=[r=Math.cos(t),0,o,0,0,1,0,0,-o,0,r,0,0,0,0,1],mat.mul(e,n)},rotateZ:function(e,t){var r,n,o;return o=Math.sin(t),n=[r=Math.cos(t),o,0,0,-o,r,0,0,0,0,1,0,0,0,0,1],mat.mul(e,n)},lookat:function(e,t,r,n){var o,i,s,a,u;return u=vec.unit(vec.sub(t,r)),s=vec.unit(vec.cross(u,n)),a=vec.unit(vec.cross(s,u)),o=vec.dot,i=[s[0],a[0],u[0],0,s[1],a[1],u[1],0,s[2],a[2],u[2],0,-o(s,t),-o(a,t),-o(u,t),1],mat.mul(e,i)},identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},frustum:function(e,t,r,n,o,i){return[2*o/(t-e),0,0,0,0,2*o/(n-r),0,0,(t+e)/(t-e),(n+r)/(n-r),-(i+o)/(i-o),-1,0,0,-i*o*2/(i-o),0]},perspective:function(e,t,r,n){var o,i;return o=(i=r*Math.tan(e*Math.PI/360))*t,mat.frustum(-o,o,-i,i,r,n)}},(e3d=e3d||{}).Mesh=function(){function e(e){var t;t=e3d.gl,e3d.program.mesh,this.vertexbuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertexbuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW),this.nvertices=e.length/8}return e.prototype.render=function(){var e,t;return e=e3d.gl,t=e3d.program.mesh,e.bindBuffer(e.ARRAY_BUFFER,this.vertexbuffer),e.vertexAttribPointer(t.aPositionLoc,3,e.FLOAT,!1,32,0),e.vertexAttribPointer(t.aTexCoordLoc,2,e.FLOAT,!1,32,12),e.vertexAttribPointer(t.aColorLoc,3,e.FLOAT,!1,32,20),e.drawArrays(e.TRIANGLES,0,this.nvertices)},e}(),(e3d=e3d||{}).Object=function(){function e(){this.position=[0,0,0],this.rotation=[0,0,0],this.scale=[1,1,1],this.meshes=[],this.textures=[],this.children=[]}return e.prototype.render=function(e){var t,r,n,o,i,s,a,u,c,l,h;for(e3d.gl,o=e3d.program.mesh,e=mat.translate(e,this.position),e=mat.rotateX(e,this.rotation[0]),e=mat.rotateY(e,this.rotation[1]),e=mat.rotateZ(e,this.rotation[2]),e=mat.scale(e,this.scale),o.setMatrix(e),e3d.noTexture.use(),r=i=0,a=(c=this.meshes).length;i<a;r=++i)null!=(n=c[r])&&(null!=this.textures[r]&&this.textures[r].use(),n.render());for(h=[],s=0,u=(l=this.children).length;s<u;s++)null!=(t=l[s])?h.push(t.render(e)):h.push(void 0);return h},e}(),(e3d=e3d||{}).Scene=function(){function e(){this.objects=[],this.camera=null}return e.prototype.render=function(){var e,t,r,n,o,i;if(r=e3d.program.mesh,null!=this.camera){for(r.begin(),e=this.camera.createMatrix(),n=0,o=(i=this.objects).length;n<o;n++)null!=(t=i[n])&&t.render(e);return r.end()}},e}(),(e3d=e3d||{}).program={mesh:{vertexSource:"uniform mat4 uMatrix;\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nattribute vec3 aColor;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\n\nvoid main() {\n\n  gl_Position = uMatrix * vec4(aPosition,1);\n  vTexCoord = aTexCoord;\n  vColor = aColor;\n\n}",fragmentSource:"precision mediump float;\n\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\n\nvoid main() {\n\n  gl_FragColor = texture2D(uTexture, vTexCoord) * vec4(vColor,1);\n\n}",init:function(){var e,t,r,n,o;return e=e3d.gl,t=e3d.program.mesh,r=e3d.compileProgram(t.vertexSource,t.fragmentSource),n=e.getUniformLocation(r,"uMatrix"),o=e.getUniformLocation(r,"uTexture"),t.aPositionLoc=e.getAttribLocation(r,"aPosition"),t.aTexCoordLoc=e.getAttribLocation(r,"aTexCoord"),t.aColorLoc=e.getAttribLocation(r,"aColor"),e.useProgram(r),e.uniform1i(o,0),e.useProgram(null),t.setMatrix=function(t){return e.uniformMatrix4fv(n,!1,t)},t.begin=function(){return e.useProgram(r),e.enableVertexAttribArray(t.aPositionLoc),e.enableVertexAttribArray(t.aTexCoordLoc),e.enableVertexAttribArray(t.aColorLoc)},t.end=function(){return e.disableVertexAttribArray(t.aPositionLoc),e.disableVertexAttribArray(t.aTexCoordLoc),e.disableVertexAttribArray(t.aColorLoc),e.useProgram(null)}}}},e3d.compileProgram=function(e,t){var r,n,o;if(r=function(e,t){var r;if(r=n.createShader(e),n.shaderSource(r,t),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS))throw console.log(n.getShaderInfoLog(r)),"compileShader fail!";return r},o=(n=e3d.gl).createProgram(),n.attachShader(o,r(n.VERTEX_SHADER,e)),n.attachShader(o,r(n.FRAGMENT_SHADER,t)),n.linkProgram(o),!n.getProgramParameter(o,n.LINK_STATUS))throw console.log(n.getProgramInfoLog(o)),"linkProgram fail!";return o},(e3d=e3d||{}).Texture=function(){function e(e){var t,r;t=e3d.gl,this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),null!=e?(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),this.width=e.width,this.height=e.height):(r=new Uint8Array([255,255,255,255]),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,r),this.width=0,this.height=0)}return e.prototype.use=function(){var e;return(e=e3d.gl).bindTexture(e.TEXTURE_2D,this.texture)},e.prototype.free=function(){var e;if(e=e3d.gl,null!=this.texture)return e.deleteTexture(this.texture),this.texture=null},e}(),vec={equal:function(e,t){return e===t||e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},add:function(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2]]},sub:function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},mul:function(e,t){return[e[0]*t,e[1]*t,e[2]*t]},div:function(e,t){return[e[0]/t,e[1]/t,e[2]/t]},neg:function(e){return[-e[0],-e[1],-e[2]]},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},dot4:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},cross:function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]},len:function(e){return Math.sqrt(vec.dot(e,e))},unit:function(e){return vec.div(e,vec.len(e))}},BoxObject=function(e){var t,r;function n(e){this.box=e,n.__super__.constructor.call(this),0===t.length&&(t=[new e3d.Mesh(makeBox())]),this.meshes=t,this.textures=r,this.prevPosition=this.box.position,this.position=this.box.position}return __extends(n,e),t=[],r=[],n.setTextures=function(e){var t,n,o,i,s;for(s=[],t=o=0,i=e.length;o<i;t=++o)n=e[t],s.push(r[t]=n);return s},n.prototype.animate=function(e){var t,r,n,o;return n=this.box.position,e!==LevelView.ANIMATION_FRAMES_PER_STEP?(t=vec.sub(n,this.prevPosition),o=e/LevelView.ANIMATION_FRAMES_PER_STEP,r=vec.mul(t,o),this.position=vec.add(this.prevPosition,r)):(this.position=n,this.prevPosition=n)},n.prototype.render=function(e){return n.__super__.render.call(this,e)},n}(e3d.Object),Camera=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),1.3,.1,t.prototype.rotate=function(e,t){var r;return(r=vec.add(this.rotation,[t,0,e]))[0]=Math.min(r[0],1.3),r[0]=Math.max(r[0],.1),this.rotation=r},t}(e3d.Camera),LevelView=function(){function e(){var e;this.camera=new Camera,this.camera.distance=12,this.scene=new e3d.Scene,this.scene.camera=this.camera,e=this,loadImageFiles({sky:["/textures/sky.png"],level:["/textures/wall.png","/textures/floor.png","/textures/platform.png"],box:["/textures/box.png"],lift:["/textures/lift.png","/textures/lifttop.png"],player:["/textures/player.png"]},function(t){return SkyObject.setTextures(createTextures(t.sky)),StaticLevelObject.setTextures(createTextures(t.level)),BoxObject.setTextures(createTextures(t.box)),LiftObject.setTextures(createTextures(t.lift)),PlayerObject.setTextures(createTextures(t.player)),e3d.scene=e.scene}),this.currState=null,this.onAnimationFinished=null,this.animationFramesLeft=0}return 6,e.ANIMATION_FRAMES_PER_STEP=6,e.prototype.build=function(e){var t,r,n;return t=[e.width/2,e.depth/2,e.height/2],this.camera.position=t,this.camera.rotation=[.5,0,0],(n=new SkyObject).position=t,r=new StaticLevelObject(e),this.boxGroup=new e3d.Object,this.boxGroup.children=e.forEach("box",function(e,t){return new BoxObject(e)}),this.liftGroup=new e3d.Object,this.liftGroup.children=e.forEach("lift",function(e,t,r,n){return new LiftObject(e)}),this.player=new PlayerObject(e.player),this.scene.objects=[n,r,this.boxGroup,this.liftGroup,this.player]},e.prototype.update=function(e,t){var r;if(e!==this.currState&&(this.currState=e,this.build(e),r=this,e3d.onrender=function(){var e,t,n,o,i,s,a,u,c,l,h,p,f;if(u=r.player,t=r.boxGroup.children,a=r.liftGroup.children,(e=r.animationFramesLeft)>0){for(s=6-e+1,u.animate(s),l=0,p=t.length;l<p;l++)t[l].animate(s);for(h=0,f=a.length;h<f;h++)a[h].animate(s);r.animationFramesLeft--}else null!=(n=r.onAnimationFinished)&&(r.onAnimationFinished=null,n());return o=r.camera,i=vec.sub(vec.add(u.position,[0,0,0]),o.position),c=vec.mul(i,.05),o.position=vec.add(o.position,c)}),null!=t[0])return this.onAnimationFinished=t[0],this.animationFramesLeft=6},e}(),LiftObject=function(e){var t,r;function n(e){this.lift=e,n.__super__.constructor.call(this),0===t.length&&(t=[new e3d.Mesh(makeLidlessBox()),new e3d.Mesh(makeTopFace())]),this.meshes=t,this.textures=r,this.prevPosition=this.lift.position,this.position=this.lift.position}return __extends(n,e),t=[],r=[],n.setTextures=function(e){var t,n,o,i,s;for(s=[],t=o=0,i=e.length;o<i;t=++o)n=e[t],s.push(r[t]=n);return s},n.prototype.animate=function(e){var t,r,n,o;return n=this.lift.position,e!==LevelView.ANIMATION_FRAMES_PER_STEP?(t=vec.sub(n,this.prevPosition),o=e/LevelView.ANIMATION_FRAMES_PER_STEP,r=vec.mul(t,o),this.position=vec.add(this.prevPosition,r)):(this.position=n,this.prevPosition=n)},n.prototype.render=function(e){return n.__super__.render.call(this,e)},n}(e3d.Object),PlayerObject=function(e){var t,r;function n(e){var o;this.player=e,n.__super__.constructor.call(this),0===t.length&&(t[0]=null,loadJsonFile("models/player.json",function(e){return t[0]=new e3d.Mesh(e)})),this.meshes=t,this.textures=r,o=vec.add(this.player.position,[.5,.5,.5]),this.prevPosition=o,this.position=o,this.scale=[.5,.5,.5]}return __extends(n,e),t=[],r=[],n.setTextures=function(e){var t,n,o,i,s;for(s=[],t=o=0,i=e.length;o<i;t=++o)n=e[t],s.push(r[t]=n);return s},n.prototype.animate=function(e){var t,r,n,o;return n=vec.add(this.player.position,[.5,.5,.5]),e!==LevelView.ANIMATION_FRAMES_PER_STEP?(t=vec.sub(n,this.prevPosition),o=e/LevelView.ANIMATION_FRAMES_PER_STEP,r=vec.mul(t,o),this.position=vec.add(this.prevPosition,r)):(this.position=n,this.prevPosition=n)},n.prototype.render=function(e){var t,r;return t=this.player.direction,r=Math.PI/2,vec.equal(t,[0,1,0])&&(this.rotation=[0,0,0*r]),vec.equal(t,[-1,0,0])&&(this.rotation=[0,0,1*r]),vec.equal(t,[0,-1,0])&&(this.rotation=[0,0,2*r]),vec.equal(t,[1,0,0])&&(this.rotation=[0,0,3*r]),n.__super__.render.call(this,e)},n}(e3d.Object),SkyObject=function(e){var t,r;function n(){n.__super__.constructor.call(this),0===t.length&&(t[0]=null,loadJsonFile("models/sky.json",function(e){return t[0]=new e3d.Mesh(e)})),this.meshes=t,this.textures=r,this.scale=[75,75,75]}return __extends(n,e),t=[],r=[],n.setTextures=function(e){var t,n,o,i,s;for(s=[],t=o=0,i=e.length;o<i;t=++o)n=e[t],s.push(r[t]=n);return s},n}(e3d.Object),StaticLevelObject=function(e){var t;function r(e){var n,o,i;r.__super__.constructor.call(this),e.width,e.depth,o=[],i=[],n=[],e.forEachBlock(function(t,r){var s,a,u,c,l;if(t.static&&(u=e.blockAt(vec.add(r,[-1,0,0])),c=e.blockAt(vec.add(r,[1,0,0])),s=e.blockAt(vec.add(r,[0,-1,0])),a=e.blockAt(vec.add(r,[0,1,0])),l=e.blockAt(vec.add(r,[0,0,1])),u.static||(o=o.concat(makeLeftFace(r))),c.static||(o=o.concat(makeRightFace(r))),s.static||(o=o.concat(makeBackFace(r))),a.static||(o=o.concat(makeFrontFace(r))),!l.static&&("solid"===t.type&&(i=i.concat(makeTopFace(r))),"platform"===t.type)))return n=n.concat(makeTopFace(r))}),this.meshes=[new e3d.Mesh(o),new e3d.Mesh(i),new e3d.Mesh(n)],this.textures=t}return __extends(r,e),t=[],r.setTextures=function(e){var r,n,o,i,s;for(s=[],r=o=0,i=e.length;o<i;r=++o)n=e[r],s.push(t[r]=n);return s},r}(e3d.Object),createTextures=function(e){var t,r,n,o;for(o=[],r=0,n=e.length;r<n;r++)t=e[r],o.push(new e3d.Texture(t));return o},makeQuad=function(e,t){var r,n,o,i,s;return o=e,i=t[0],n=t[1],r=t[2],s=[[o[0][0],o[0][1],o[0][2],0,0,i,n,r],[o[1][0],o[1][1],o[1][2],1,0,i,n,r],[o[2][0],o[2][1],o[2][2],0,1,i,n,r],[o[3][0],o[3][1],o[3][2],1,1,i,n,r]],[].concat(s[0],s[1],s[2],s[3],s[2],s[1])},makeLeftFace=function(e){var t,r,n;return null==e&&(e=[0,0,0]),t=e[0],r=e[1],n=e[2],makeQuad([[t,r,n+1],[t,r+1,n+1],[t,r,n],[t,r+1,n]],[.7,.7,.7])},makeRightFace=function(e){var t,r,n;return null==e&&(e=[0,0,0]),t=e[0],r=e[1],n=e[2],makeQuad([[t+1,r+1,n+1],[t+1,r,n+1],[t+1,r+1,n],[t+1,r,n]],[.8,.8,.8])},makeBackFace=function(e){var t,r,n;return null==e&&(e=[0,0,0]),t=e[0],r=e[1],n=e[2],makeQuad([[t+1,r,n+1],[t,r,n+1],[t+1,r,n],[t,r,n]],[.6,.6,.6])},makeFrontFace=function(e){var t,r,n;return null==e&&(e=[0,0,0]),t=e[0],r=e[1],n=e[2],makeQuad([[t,r+1,n+1],[t+1,r+1,n+1],[t,r+1,n],[t+1,r+1,n]],[.9,.9,.9])},makeTopFace=function(e){var t,r,n;return null==e&&(e=[0,0,0]),t=e[0],r=e[1],n=e[2],makeQuad([[t,r,n+1],[t+1,r,n+1],[t,r+1,n+1],[t+1,r+1,n+1]],[1,1,1])},makeLidlessBox=function(e){return[].concat(makeLeftFace(e),makeRightFace(e),makeBackFace(e),makeFrontFace(e))},makeBox=function(e){return[].concat(makeLidlessBox(e),makeTopFace(e))},Zoko=function(){return function(e){var t,r,n,o,i;t=e.find("canvas")[0],r=e.find("#overlay"),e3d.init(t),o=new LevelView,new PlayerController(o),new CameraController(o,r),n=new Game(o),i=new UI(n),n.observers=[i],e3d.run()}}();