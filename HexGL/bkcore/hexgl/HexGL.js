"use strict";var bkcore=bkcore||{};bkcore.hexgl=bkcore.hexgl||{},bkcore.hexgl.HexGL=function(e){var t=this;this.document=e.document||document,this.a=window.location.href,this.active=!0,this.displayHUD=null==e.hud||e.hud,this.width=null==e.width?window.innerWidth:e.width,this.height=null==e.height?window.innerHeight:e.height,this.difficulty=null==e.difficulty?0:e.difficulty,this.player=null==e.player?"Anonym":e.player,this.track=bkcore.hexgl.tracks[null==e.track?"Cityscape":e.track],this.mode=null==e.mode?"timeattack":e.mode,this.controlType=null==e.controlType?1:e.controlType,this.quality=null==e.quality?3:e.quality,0===this.quality&&(this.width/=2,this.height/=2),this.settings=null,this.renderer=null,this.manager=null,this.lib=null,this.materials={},this.components={},this.extras={vignetteColor:new THREE.Color(4557489),bloom:null,fxaa:null},this.containers={},this.containers.main=null==e.container?document.body:e.container,this.containers.overlay=null==e.overlay?document.body:e.overlay,this.gameover=null==e.gameover?null:e.gameover,this.godmode=null!=e.godmode&&e.godmode,this.hud=null,this.gameplay=null,this.composers={game:null},this.initRenderer(),this.document.addEventListener("keydown",function(e){27==e.keyCode&&t.reset()},!1)},bkcore.hexgl.HexGL.prototype.start=function(){this.manager.setCurrent("game");var e=this;!function t(){e&&e.active&&requestAnimationFrame(t),e.update()}(),this.initGameplay()},bkcore.hexgl.HexGL.prototype.reset=function(){this.manager.get("game").objects.lowFPS=0,this.gameplay.start(),bkcore.Audio.stop("bg"),bkcore.Audio.stop("wind"),bkcore.Audio.volume("wind",.35),bkcore.Audio.play("bg"),bkcore.Audio.play("wind")},bkcore.hexgl.HexGL.prototype.restart=function(){try{this.document.getElementById("finish").style.display="none"}catch(e){}this.reset()},bkcore.hexgl.HexGL.prototype.update=function(){this.active&&(null!=this.gameplay&&this.gameplay.update(),this.manager.renderCurrent())},bkcore.hexgl.HexGL.prototype.init=function(){this.initHUD(),this.track.buildMaterials(this.quality),this.track.buildScenes(this,this.quality),this.initGameComposer()},bkcore.hexgl.HexGL.prototype.load=function(e){this.track.load(e,this.quality)},bkcore.hexgl.HexGL.prototype.initGameplay=function(){var e=this;this.gameplay=new bkcore.hexgl.Gameplay({mode:this.mode,hud:this.hud,shipControls:this.components.shipControls,cameraControls:this.components.cameraChase,analyser:this.track.analyser,pixelRatio:this.track.pixelRatio,track:this.track,onFinish:function(){e.components.shipControls.terminate(),e.displayScore(this.finishTime,this.lapTimes)}}),this.gameplay.start(),bkcore.Audio.play("bg"),bkcore.Audio.play("wind"),bkcore.Audio.volume("wind",.35)},bkcore.hexgl.HexGL.prototype.displayScore=function(e,t){this.active=!1;var i=bkcore.Timer.msToTimeString(e),n=[bkcore.Timer.msToTimeString(t[0]),bkcore.Timer.msToTimeString(t[1]),bkcore.Timer.msToTimeString(t[2])];if(null!==this.gameover)return this.gameover.style.display="block",this.gameover.children[0].innerHTML=i.m+"'"+i.s+"''"+i.ms,void(this.containers.main.parentElement.style.display="none");var s=this.track,r=this.document.getElementById("finish"),a=this.document.getElementById("finish-state"),o=this.document.getElementById("finish-hallmsg"),l=this.document.getElementById("finish-msg"),h=this.document.getElementById("finish-result"),d=this.document.getElementById("finish-lap1"),c=this.document.getElementById("finish-lap2"),m=this.document.getElementById("finish-lap3"),u=this.document.getElementById("finish-diff"),g=this.document.getElementById("finish-twitter"),p=this.document.getElementById("finish-fb"),y=this.document.getElementById("lowfps-msg"),f=0==this.difficulty?"casual":"hard",b=this.hud.timeSeparators;if(this.gameplay.result==this.gameplay.results.FINISH){null!=a&&(a.innerHTML="Finished!"),"undefined"!=typeof Storage&&(null==localStorage["score-"+s+"-"+f]||localStorage["score-"+s+"-"+f]>e?(null!=l&&(l.innerHTML="New local record!"),localStorage["score-"+s+"-"+f]=e,localStorage["race-"+s+"-replay"]=JSON.Stringify(this.gameplay.raceData.export())):null!=l&&(l.innerHTML="Well done!"));var k=bkcore.hexgl.Ladder.global[s][f][bkcore.hexgl.Ladder.global[s][f].length-2];null!=k&&k.score>e?null!=o&&(o.innerHTML="You made it to the HOF!"):null!=o&&(o.innerHTML="Hall Of Fame"),null!=h&&(h.innerHTML=i.m+b[1]+i.s+b[2]+i.ms),null!=d&&(d.innerHTML=null!=n[0].m?n[0].m+b[1]+n[0].s+b[2]+n[0].ms:"-"),null!=c&&(c.innerHTML=null!=n[1].m?n[1].m+b[1]+n[1].s+b[2]+n[1].ms:"-"),null!=m&&(m.innerHTML=null!=n[2].m?n[2].m+b[1]+n[2].s+b[2]+n[2].ms:"-")}else null!=a&&(a.innerHTML="Destroyed!"),null!=l&&(l.innerHTML="Maybe next time!"),null!=o&&(o.innerHTML="Hall Of Fame"),null!=h&&(h.innerHTML="None"),null!=d&&(d.innerHTML="None"),null!=c&&(c.innerHTML="None"),null!=m&&(m.innerHTML="None");null!=u&&(u.innerHTML=f),null!=g&&(g.href="http://twitter.com/share?text="+encodeURIComponent("I just scored "+h.innerHTML+" in Cityscape ("+f+") on #HexGL! Come try it and beat my record on ")),null!=p&&(p.href="http://www.facebook.com/sharer.php?s=100&p[title]="+encodeURIComponent("I just scored "+h.innerHTML+" in Cityscape ("+f+") on HexGL!")+"&p[summary]="+encodeURIComponent("HexGL is a futuristic racing game built by Thibaut Despoulain (BKcore) using HTML5, Javascript and WebGL. Come challenge your friends on this fast-paced 3D game!")+"&p[url]="+encodeURIComponent("http://hexgl.bkcore.com")+"&p[images][0]="+encodeURIComponent("http://hexgl.bkcore.com/image.png")),bkcore.hexgl.Ladder.displayLadder("finish-ladder",s,f,8),this.manager.get("game").objects.lowFPS>=999?null!=y&&(y.innerHTML="Note: Your framerate was pretty low, you should try a lesser graphic setting!"):null!=y&&(y.innerHTML=""),r.style.display="block"},bkcore.hexgl.HexGL.prototype.initRenderer=function(){var e=new THREE.WebGLRenderer({antialias:!1,clearColor:0});this.quality>2&&(e.physicallyBasedShading=!0,e.gammaInput=!0,e.gammaOutput=!0,e.shadowMapEnabled=!0,e.shadowMapSoft=!0),e.autoClear=!1,e.sortObjects=!1,e.setSize(this.width,this.height),e.domElement.style.position="relative",this.containers.main.appendChild(e.domElement),this.canvas=e.domElement,this.renderer=e,this.manager=new bkcore.threejs.RenderManager(e)},bkcore.hexgl.HexGL.prototype.initHUD=function(){this.displayHUD&&(this.hud=new bkcore.hexgl.HUD({width:this.width,height:this.height,font:"BebasNeueRegular",bg:this.track.lib.get("images","hud.bg"),speed:this.track.lib.get("images","hud.speed"),shield:this.track.lib.get("images","hud.shield")}),this.containers.overlay.appendChild(this.hud.canvas))},bkcore.hexgl.HexGL.prototype.initGameComposer=function(){var e={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1},t=new THREE.WebGLRenderTarget(this.width,this.height,e),i=new THREE.RenderPass(this.manager.get("sky").scene,this.manager.get("sky").camera),n=new THREE.RenderPass(this.manager.get("game").scene,this.manager.get("game").camera);n.clear=!1,this.composers.game=new THREE.EffectComposer(this.renderer,t);var s=new THREE.ShaderPass(THREE.ShaderExtras.screen);s.renderToScreen=!0;new THREE.ShaderPass(THREE.ShaderExtras.vignette);var r=new THREE.ShaderPass(bkcore.threejs.Shaders.hexvignette);if(r.uniforms.size.value=this.width/1633*512,r.uniforms.rx.value=this.width,r.uniforms.ry.value=this.height,r.uniforms.tHex.texture=this.track.lib.get("textures","hex"),r.uniforms.color.value=this.extras.vignetteColor,r.renderToScreen=!0,this.composers.game.addPass(i),this.composers.game.addPass(n),this.quality>2){var a=new THREE.BloomPass(.8,25,4,256);this.composers.game.addPass(a),this.extras.bloom=a}this.quality>0?this.composers.game.addPass(r):this.composers.game.addPass(s)},bkcore.hexgl.HexGL.prototype.createMesh=function(e,t,i,n,s,r){t.computeTangents();var a=new THREE.Mesh(t,r);return a.position.set(i,n,s),e.add(a),this.quality>2&&(a.castShadow=!0,a.receiveShadow=!0),a},bkcore.hexgl.HexGL.prototype.tweakShipControls=function(){var e=this.components.shipControls;1==this.difficulty?(e.airResist=.035,e.airDrift=.07,e.thrust=.035,e.airBrake=.04,e.maxSpeed=9.6,e.boosterSpeed=.35*e.maxSpeed,e.boosterDecay=.007,e.angularSpeed=.014,e.airAngularSpeed=.0165,e.rollAngle=.6,e.shieldDamage=.03,e.collisionSpeedDecrease=.8,e.collisionSpeedDecreaseCoef=.5,e.rollLerp=.1,e.driftLerp=.4,e.angularLerp=.4):0==this.difficulty&&(e.airResist=.02,e.airDrift=.06,e.thrust=.02,e.airBrake=.025,e.maxSpeed=7,e.boosterSpeed=.5*e.maxSpeed,e.boosterDecay=.007,e.angularSpeed=.0125,e.airAngularSpeed=.0135,e.rollAngle=.6,e.shieldDamage=.06,e.collisionSpeedDecrease=.8,e.collisionSpeedDecreaseCoef=.5,e.rollLerp=.07,e.driftLerp=.3,e.angularLerp=.4),this.godmode&&(e.shieldDamage=0)};