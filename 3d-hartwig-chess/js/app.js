var chess=new Chess,currentColor=chess.turn(),turn=0,timeOut=null,photon=document.getElementsByClassName("photon-shader"),sphere=document.getElementsByClassName("sphere"),piece=document.getElementsByClassName("piece"),square=document.getElementsByClassName("square"),app=document.getElementById("app"),scene=document.getElementById("scene"),sceneX=70,sceneY=90,controls=!1,animated=!1,mouseDown=!1,closestElement=null,white="White",black="Black";function checkTouch(){var e=document.createElement("div");return e.setAttribute("ontouchmove","return;"),"function"==typeof e.ontouchmove}if(checkTouch())var press="touchstart",drag="touchmove",drop="touchend";else press="mousedown",drag="mousemove",drop="mouseup";function initControls(){for(var e=0;e<piece.length;e++)piece[e].addEventListener(press,grabPiece,!1);app.addEventListener(drag,dragPiece,!1),app.addEventListener(drop,dropPiece,!1),app.addEventListener(drag,moveScene,!1),app.onselectstart=function(e){e.preventDefault()},app.ontouchmove=function(e){e.preventDefault()}}function grabPiece(e){!mouseDown&&controls&&(e.preventDefault(),mouseDown=!0,grabbed=this,grabbedID=grabbed.id.substr(-2),startX=e.pageX-document.body.offsetWidth/2,startY=e.pageY-document.body.offsetHeight/2,style=window.getComputedStyle(grabbed),matrix=style.getPropertyValue("-webkit-transform"),matrixParts=matrix.split(","),grabbedW=parseInt(style.getPropertyValue("width"))/2,grabbedX=parseInt(matrixParts[4]),grabbedY=parseInt(matrixParts[5]),grabbed.classList.add("grabbed"),showMoves(grabbedID),highLight(grabbed,square))}function dragPiece(e){mouseDown&&controls&&(e.preventDefault(),moveX=e.pageX-document.body.offsetWidth/2,moveY=e.pageY-document.body.offsetHeight/2,distX=moveX-startX,distY=moveY-startY,"w"===currentColor?(newX=grabbedX+distX,newY=grabbedY+distY):(newX=-(grabbedX+distX),newY=-(grabbedY+distY)),grabbed.style.webkitTransform="translateX("+newX+"px) translateY("+newY+"px) translateZ(2px)",highLight(grabbed,square))}function dropPiece(e){if(mouseDown&&controls){e.preventDefault();var t=closestElement.id;function n(e){return document.getElementById(t).className.match(new RegExp("(\\s|^)"+e+"(\\s|$)"))}if(n("valid")){if(n("captured")){var a=chess.get(t).type,o=chess.get(t).color;createPiece(o,a,"w"===currentColor?"w-jail":"b-jail")}hideMoves(grabbedID),chess.move({from:grabbedID,to:t,promotion:"q"})}else hideMoves(grabbedID),grabbed.style.webkitTransform="translateX(0px) translateY(0px) translateZ(2px)";updateBoard(),grabbed.classList.remove("grabbed"),mouseDown=!1}}function moveScene(e){if(animated&&(eventStartX=e.pageX-document.body.offsetWidth/2,eventStartY=e.pageY-document.body.offsetHeight/2),eventStartX=0,eventStartY=0,!controls&&!animated){document.body.classList.remove("animated"),e.preventDefault(),eventMoveX=e.pageX-document.body.offsetWidth/2,eventDistX=eventMoveX-eventStartX,eventMoveY=e.pageY-document.body.offsetHeight/2,eventDistY=eventMoveY-eventStartY,eventX=sceneY- -.03*eventDistX,eventY=sceneX- -.03*eventDistY,scene.style.webkitTransform="RotateX("+eventY+"deg) RotateZ("+eventX+"deg)";for(var t=0;t<sphere.length;t++)updateSphere(sphere[t],eventY,eventX)}}function showMoves(e){for(var t=chess.moves({target:e,verbose:!0}),n=0;n<t.length;n++){var a=t[n],o=a.from,s=a.to,r=a.captured;document.getElementById(o).classList.add("current"),document.getElementById(s).classList.add("valid"),r&&document.getElementById(s).classList.add("captured")}}function hideMoves(e){for(var t=chess.moves({target:e,verbose:!0}),n=0;n<t.length;n++){var a=t[n],o=a.from,s=a.to;document.getElementById(o).classList.remove("current"),document.getElementById(s).classList.remove("valid"),document.getElementById(s).classList.remove("captured")}}function createPiece(e,t,n){var a=document.getElementById(t).cloneNode(!0);a.addEventListener(press,grabPiece,!1),a.setAttribute("id",e+t+n),"w"===e?a.classList.add("white"):a.classList.add("black"),document.getElementById(n).appendChild(a)}function updateBoard(){var e={},t=chess.in_check(),n=chess.in_checkmate();chess.in_draw(),chess.in_stalemate(),chess.in_threefold_repetition();for(var a in chess.SQUARES.forEach(function(t){var n=board[t],a=chess.get(t);n&&a?n.type===a.type&&n.color===a.color||(e[t]=a):(n||a)&&(e[t]=a),board[t]=a}),e){var o=document.getElementById([a]);if(null===e[a])o.innerHTML="";else{var s=e[a].color,r=e[a].type;currentColor!==s||o.hasChildNodes()?(o.innerHTML="",createPiece(s,r,[a])):createPiece(s,r,[a])}}var d=chess.fen();function i(e){document.getElementById("log").innerHTML=e}currentColor=chess.turn(),document.getElementById("undo").dataset.state="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"!==d?"active":"inactive","w"===currentColor?(updateView(0,0),i(white+"'s turn"),t&&i(white+"'s king is in check !"),n&&i(white+"'s king is in checkmate ! "+black+" wins !")):(updateView(0,180),i(black+"'s turn"),t&&i(black+"'s king is in check !"),n&&i(black+"'s king is in checkmate ! "+white+" wins"))}function updateCaptured(){var e=document.getElementById("board").getElementsByClassName("white"),t=document.getElementById("board").getElementsByClassName("black"),n=document.getElementById("w-jail").getElementsByClassName("black"),a=document.getElementById("b-jail").getElementsByClassName("white");if(e.length+a.length!==16){var o=document.getElementById("b-jail").lastChild;document.getElementById("b-jail").removeChild(o)}if(t.length+n.length!==16){o=document.getElementById("w-jail").lastChild;document.getElementById("w-jail").removeChild(o)}}function undoMove(){chess.undo(),updateBoard(),updateCaptured()}function highLight(e,t){function n(e){var t=e.getBoundingClientRect();return{x:t.left,y:t.top}}var a=n(e).x+grabbedW;elementRight=a+e.offsetWidth-grabbedW,elementTop=n(e).y+grabbedW,elementBottom=elementTop+e.offsetHeight-grabbedW,smallestDistance=null;for(var o=0;o<t.length;o++){if("w"===currentColor)var s=(d=n(t[o]).x)+t[o].offsetWidth,r=(i=n(t[o]).y)+t[o].offsetHeight;else{var d,i;s=(d=n(t[o]).x+grabbedW)+t[o].offsetWidth,r=(i=n(t[o]).y+grabbedW)+t[o].offsetHeight}var c=0,l=0;s<a?c=a-s:d>elementRight&&(c=d-elementRight),r<elementTop?l=elementTop-r:i>elementBottom&&(l=i-elementBottom);var m=0;m=c>l?c:l,null===smallestDistance?(smallestDistance=m,closestElement=t[o]):m<smallestDistance&&(smallestDistance=m,closestElement=t[o])}for(o=0;o<t.length;o++)t[o].classList.remove("highlight");closestElement.classList.add("highlight"),targetX=closestElement.offsetLeft,targetY=closestElement.offsetTop}function updateView(e,t){scene.style.webkitTransform="rotateX( "+e+"deg) rotateZ( "+t+"deg)";for(var n=0;n<sphere.length;n++)updateSphere(sphere[n],e,t)}function updateSphere(e,t,n){e.style.WebkitTransform="rotateZ( "+-n+"deg ) rotateX( "+-t+"deg )"}function renderPoly(){var e=new Photon.Light(x=50,y=150,z=250);new Photon.FaceGroup($("#container")[0],$("#container .face"),1.6,.48,!0).render(e,!0)}function resetPoly(){for(var e=0;e<photon.length;e++)photon[e].setAttribute("style","");null!=timeOut&&clearTimeout(timeOut),timeOut=setTimeout(renderPoly,250)}function Continue(){updateBoard(),controls=!0,animated=!0,document.getElementById("app").dataset.state="game",document.body.classList.add("animated")}function optionScreen(){updateView(sceneX,sceneY),controls=!1,document.getElementById("app").dataset.state="menu",setTimeout(function(){animated=!1},2500)}function toggleFrame(e){e.checked?document.getElementById("app").dataset.frame="on":document.getElementById("app").dataset.frame="off",resetPoly()}function setState(e){e.preventDefault();var t=this.dataset.menu;document.getElementById("app").dataset.menu=t}function setTheme(e){e.preventDefault();var t=this.dataset.theme;document.getElementById("app").dataset.theme=t,"classic"===t||"marble"===t?(white="White",black="Black"):"flat"!==t&&"wireframe"!==t||(white="Blue",black="Red")}function UI(){for(var e=document.getElementsByClassName("menu-nav"),t=document.getElementsByClassName("set-theme"),n=0;n<e.length;n++)e[n].addEventListener(press,setState,!1);for(n=0;n<t.length;n++)t[n].addEventListener(press,setTheme,!1);document.getElementById("continue").addEventListener(press,Continue,!1),document.getElementById("open-menu").addEventListener(press,optionScreen,!1),document.getElementById("undo").addEventListener(press,undoMove,!1)}function init(){app.classList.remove("loading"),document.body.classList.add("animated"),animated=!0,updateBoard(),optionScreen(),initControls(),UI(),setTimeout(function(){document.getElementById("logo").innerHTML=""},2e3)}window.addEventListener("resize",resetPoly,!1);var readyStateCheckInterval=setInterval(function(){"complete"===document.readyState&&(renderPoly(),init(),clearInterval(readyStateCheckInterval))},3250);